<!-- File: /ui/mobile/dashboard.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ëŒ€ì‹œë³´ë“œ - ëª¨ë°”ì¼</title>
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/mobile.css" />
  <script type="module">
    import { redirectToDesktopIfNeeded } from '../js/mobile.js';
    redirectToDesktopIfNeeded('../html/dashboard.html');
  </script>
</head>
<body class="mobile-app app-loading">
  <div id="app-shell-loader" class="app-shell-loader">
    <div class="spinner" aria-label="ë¡œë”© ì¤‘"></div>
    <div class="muted">í•„ìš”í•œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
  <header class="mobile-header">
    <div class="mobile-top">
      <div class="mobile-brand"><img src="../assets/logo.png" alt="logo" />ëŒ€ì‹œë³´ë“œ</div>
      <button class="btn tiny muted" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="mobile-status-row">
      <div class="system-status-badge">
        <div class="status-label">ì—°ê²° ìƒíƒœ</div>
        <div class="system-status">
          <span id="server-status" class="status-chip status-pending" title="ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘">
            <span class="status-dot"></span>
            <span class="status-text">ì„œë²„ í™•ì¸ ì¤‘</span>
          </span>
          <span id="db-status" class="status-chip status-pending" title="DB ìƒíƒœ í™•ì¸ ì¤‘">
            <span class="status-dot"></span>
            <span class="status-text">DB í™•ì¸ ì¤‘</span>
          </span>
        </div>
        <div class="status-meta" id="status-meta">ìƒíƒœ ì²´í¬ ì¤‘...</div>
      </div>
      <div class="mobile-session">
        <span id="session-countdown" class="status-chip session-timer"></span>
        <button class="btn tiny secondary" id="extend-session" style="display:none;">ì„¸ì…˜ ì—°ì¥</button>
        <span class="mobile-user">ì•ˆë…•í•˜ì„¸ìš”, <span id="user-name"></span> (<span id="user-role"></span>)</span>
      </div>
    </div>
  </header>
  <main class="mobile-content">
    <section class="card" id="card-today">
      <div class="card-title">ì˜¤ëŠ˜ ì¼ì •</div>
      <div id="today-info" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </section>
    <section class="card" id="card-pending">
      <div class="card-title">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­</div>
      <div id="pending-summary" class="stack tight">
        <div id="pending-count" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <ul id="pending-insights" class="compact-list"></ul>
      </div>
    </section>
    <section class="card" id="card-weekly">
      <div class="card-title">ì£¼ê°„ ê·¼ë¬´ ì‹œê°„í‘œ</div>
      <div id="schedule-summary" class="loader">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </section>
    <section class="card">
      <div class="card-title">ì „ì²´ ë©”ë‰´</div>
      <div class="mobile-menu-grid">
        <a class="nav-link" data-page="overview" href="schedule_overview.html">ê·¼ë¬´ ì‹œê°„í‘œ<span>ì£¼ê°„ ì¼ì • í™•ì¸</span></a>
        <a class="nav-link" data-page="profile" href="member_profile.html">ë‚´ í”„ë¡œí•„<span>ê³„ì • Â· ë¹„ë°€ë²ˆí˜¸</span></a>
        <a class="nav-link" data-page="requests" data-roles="MASTER,MEMBER" href="request_center.html">ê·¼ë¬´ ë³€ê²½ ì‹ ì²­<span>ê²°ê·¼/ì¶”ê°€ ìš”ì²­</span></a>
        <a class="nav-link" data-page="approvals" data-roles="MASTER,OPERATOR" href="request_approvals.html">ë³€ê²½ ìŠ¹ì¸í•¨<span>ëŒ€ê¸° ìš”ì²­ ì²˜ë¦¬</span></a>
        <a class="nav-link" data-page="notices" href="notice_board.html">ê³µì§€ì‚¬í•­<span>ì „ì²´ ê³µì§€ í™•ì¸</span></a>
        <a class="nav-link" data-page="notice_admin" data-min-role="OPERATOR" href="notice_admin.html">ê³µì§€ ê´€ë¦¬<span>ê³µì§€ ë“±ë¡/ìˆ˜ì •</span></a>
        <a class="nav-link" data-page="members" data-min-role="OPERATOR" href="admin_members.html">êµ¬ì„±ì› ê´€ë¦¬<span>ë©¤ë²„ ê¶Œí•œ ì„¤ì •</span></a>
        <a class="nav-link" data-page="shifts" data-min-role="OPERATOR" href="admin_shifts.html">ê·¼ë¬´ ê´€ë¦¬<span>ê·¼ë¬´ ë°°ì •</span></a>
        <a class="nav-link" data-page="history" data-min-role="MASTER" href="history.html">ë³€ë™ ì´ë ¥<span>ë¡œê·¸ í™•ì¸</span></a>
      </div>
    </section>
  </main>
  <nav class="mobile-nav">
    <a class="nav-link" data-page="dashboard" href="dashboard.html"><span class="nav-icon">ğŸ </span><span>í™ˆ</span></a>
    <a class="nav-link" data-page="overview" href="schedule_overview.html"><span class="nav-icon">ğŸ“…</span><span>ì‹œê°„í‘œ</span></a>
    <a class="nav-link" data-page="requests" data-roles="MASTER,MEMBER" href="request_center.html"><span class="nav-icon">ğŸ“</span><span>ì‹ ì²­</span></a>
    <a class="nav-link" data-page="approvals" data-roles="MASTER,OPERATOR" href="request_approvals.html"><span class="nav-icon">âœ…</span><span>ìŠ¹ì¸</span></a>
    <a class="nav-link" data-page="notices" href="notice_board.html"><span class="nav-icon">ğŸ“£</span><span>ê³µì§€</span></a>
  </nav>
  <script type="module">
    import { apiRequest } from '../js/api.js';
    import { initAppLayout } from '../js/layout.js';
    import { loadGlobalSchedule, renderCompactSchedule } from '../js/schedule.js';

    const pendingInsights = document.getElementById('pending-insights');
    const user = await initAppLayout('dashboard');

    const todayCard = document.getElementById('card-today');
    const pendingCard = document.getElementById('card-pending');

    if (user?.role === 'OPERATOR') {
      if (todayCard) todayCard.style.display = 'none';
    }
    if (user?.role === 'MEMBER') {
      if (pendingCard) pendingCard.style.display = 'none';
    }

    if (user?.role === 'MEMBER' && todayCard) {
      try {
        const today = new Date();
        const dayOffset = (today.getDay() + 6) % 7;
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - dayOffset);
        const params = new URLSearchParams({ start: weekStart.toISOString().slice(0, 10) });
        const events = await apiRequest(`/schedule/weekly_view?${params.toString()}`);
        const todayStr = today.toISOString().slice(0, 10);
        const todays = events.filter((ev) => ev.date === todayStr);
        const todayInfo = document.getElementById('today-info');
        if (!todays.length) {
          todayInfo.textContent = 'ì˜¤ëŠ˜ ë°°ì • ì—†ìŒ';
        } else {
          const times = todays.map((ev) => `${ev.start_time.slice(0, 5)}~${ev.end_time.slice(0, 5)}`);
          todayInfo.innerHTML = `
            <div class="today-summary">ì˜¤ëŠ˜ ${times.join(', ')} ê·¼ë¬´ì…ë‹ˆë‹¤.</div>
            <div class="today-times">${times.map((time) => `<span class="time-chip">${time}</span>`).join('')}</div>
          `;
        }
      } catch {
        document.getElementById('today-info').textContent = 'ë°ì´í„° ì—†ìŒ';
      }
    } else if (user?.role === 'MASTER' && todayCard) {
      try {
        const mine = await apiRequest('/schedule/me');
        const today = new Date();
        const todayCount = mine.filter((m) => {
          const from = m.valid_from ? new Date(m.valid_from) : null;
          const to = m.valid_to ? new Date(m.valid_to) : null;
          if (!from) return false;
          return from <= today && (!to || to >= today);
        }).length;
        document.getElementById('today-info').textContent = todayCount ? `${todayCount}ê°œì˜ ë°°ì •` : 'ì˜¤ëŠ˜ ë°°ì • ì—†ìŒ';
      } catch {
        document.getElementById('today-info').textContent = 'ë°ì´í„° ì—†ìŒ';
      }
    } else if (todayCard) {
      document.getElementById('today-info').textContent = 'ìš´ì˜ì ëª¨ë“œì—ì„œëŠ” ì˜¤ëŠ˜ ì¼ì •ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.';
    }

    function renderPendingInsights(items) {
      if (!pendingInsights) return;
      pendingInsights.innerHTML = '';
      if (!items.length) {
        pendingInsights.innerHTML = '<li class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      const pendingCount = items.filter((r) => r.status === 'PENDING').length;
      const today = new Date().toISOString().slice(0, 10);
      const todayPending = items.filter((r) => r.status === 'PENDING' && r.target_date === today).length;
      const approved = items.filter((r) => r.status === 'APPROVED').length;
      const cancelled = items.filter((r) => r.status === 'CANCELLED').length;
      const rejected = items.filter((r) => r.status === 'REJECTED').length;
      const lastSevenDays = items.filter((r) => {
        const created = new Date(r.created_at);
        const diff = (Date.now() - created.getTime()) / (1000 * 60 * 60 * 24);
        return diff <= 7;
      }).length;
      const lines = [
        `<strong>${pendingCount}ê±´</strong> ìŠ¹ì¸ ëŒ€ê¸° (${todayPending}ê±´ì€ ì˜¤ëŠ˜ ì¼ì •)`,
        `<strong>${lastSevenDays}ê±´</strong> ìµœê·¼ 7ì¼ ì‹ ê·œ ì ‘ìˆ˜`,
        `<strong>${approved}ê±´</strong> ìŠ¹ì¸ë¨ Â· <strong>${rejected}ê±´</strong> ê±°ì ˆë¨ Â· <strong>${cancelled}ê±´</strong> ì·¨ì†Œë¨`
      ];
      lines.forEach((text) => {
        const li = document.createElement('li');
        li.innerHTML = text;
        pendingInsights.appendChild(li);
      });
      const countLabel = document.getElementById('pending-count');
      if (countLabel) {
        countLabel.textContent = pendingCount ? `${pendingCount}ê±´ ìŠ¹ì¸ ëŒ€ê¸°` : 'ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ ì—†ìŒ';
      }
    }

    if (user?.role !== 'MEMBER' && pendingCard) {
      try {
        const feed = await apiRequest('/requests/feed');
        const relevant = feed.filter((r) => ['PENDING', 'APPROVED', 'REJECTED', 'CANCELLED'].includes(r.status));
        renderPendingInsights(relevant, 'OPERATOR');
      } catch {
        document.getElementById('pending-count').textContent = 'í™•ì¸ ë¶ˆê°€';
        if (pendingInsights) pendingInsights.innerHTML = '<li class="error">ìš”ì²­ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
      }
    }

    let assignments = [];
    try {
      assignments = await loadGlobalSchedule();
    } catch (e) {
      document.getElementById('schedule-summary').textContent = 'ì¼ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    }
    renderCompactSchedule(assignments, 'schedule-summary');
  </script>
</body>
</html>
